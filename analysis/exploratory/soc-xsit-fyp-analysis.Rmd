---
title: "soc-xsit-fyp-analysis"
author: "Kyle MacDonald"
date: "August 16, 2014"
output: html_document
---

## Script to visualize and analyze social-xsl experiment 

Load libraries and helper functions

```{r load libraries, warning=F,message=F}
library(plyr)
library(dplyr)
library(bootstrap)
library(lme4)
library(ggplot2)
library(RColorBrewer)
library(directlabels)
library(xtable)
source("/Users/kmacdonald/Documents/Projects/SOC_XSIT/XSIT-MIN/analysis/Ranalysis/useful.R")

# helper function for labeling facets in ggplot
mf_labeller <- function(var, value){
  value <- as.character(value)
  if (var=="graph.numPic") { 
    value[value=="Two"] <- "2-Referents"
    value[value=="Four"] <- "4-Referents"
    value[value=="Six"] <- "6-Referents"
    value[value=="Eight"] <- "8-Referents"
  }
  return(value)
}
```

Read in the data.

```{r read data}
read_path_fyp <- file.path("/Users", "kmacdonald", "Documents", 
                       "Projects", "SOC_XSIT", "processed_data", 
                       "adult-fyp/")

d_df <- read.csv(paste(read_path_fyp,
                            "soc_xsit_expt1_master.csv", sep=""))
```

Clean up dataset 

```{r clean up dataset}
d_df <- d_df %>% select(-X.1, -X)
d_df <- anonymize.sids(d_df, "subid")
```

## Get the number of subjects in each condition.  

```{r describe data}
d_df %>%
        group_by(condition, intervalNum, numPicN) %>%
        summarise(n_subs = n_distinct(subids))
```

## Exclude subjects who were choosing randomly during exposure trials

Flag trials on which subs chose the target of eye gaze.

```{r target of gaze}
#revalue face vid to match chosen indices
d_df$faceIdx6 <- revalue(d_df$face, c("eyes_left_90"=0, "eyes_right_90"=1, 
                                        "eyes_left"=2, "eyes_down_left"=3,
                                        "eyes_down_right"=4, "eyes_right"=5, 
                                        "eyescenter"=-1))
d.expo_df <- d_df %>%
                filter(exposureTrial == 1) %>%
                mutate(correct_exposure = ifelse(numPic == 6, 
                                                 chosenIdx == faceIdx6,
                                                 chosenIdx == faceIdx)) %>%
                select(subids, itemNum, correct_exposure)
```

## Get test trials and merge with exposure trial information. 

```{r test trials w/exposure}
d.test_df <- d_df %>% filter(testTrial == 1)

d.test_df <- join(d.expo_df, d.test_df, type = "full")
```

Flag subs in the social condition who performed worse than chance on exposure trials.

```{r flag subs <25% correct on exposure}
#Flag trials with extremely slow or fast RTs (+/- 2SD).
d.test_df <- d.test_df %>%
    mutate(include_good_rt = ifelse(log(rt) > mean(log(rt)) + 2 * sd(log(rt)) |
                                        log(rt) < mean(log(rt)) - 2 * sd(log(rt)),
                                    0, 1))

d.test_df <- d.test_df %>%
    filter(condition == "Social") %>%
    group_by(subids, numPic) %>%
    summarise(mean_acc_exp = mean(correct_exposure)) %>%
    mutate(include_expo = ifelse(numPic == 2 & mean_acc_exp > 0.5, 1, 
                                 ifelse(numPic == 4 & mean_acc_exp > 0.25, 1,
                                        ifelse(numPic == 6 & mean_acc_exp > 0.17, 1, 
                                               ifelse(numPic == 8 & mean_acc_exp > 0.125, 1, 
                                                      0))))) %>%
    join(d.test_df, by = "subids", type = "full")
```

Get exposure data.

```{r exposure trials filter}
d.exp_analysis <- d_df %>% filter(exposureTrial == 1)

# remove trials with 0 RT
d.exp_analysis <- filter(d.exp_analysis, rt > 0)

#filter out bad rts
d.exp_analysis <- d.exp_analysis %>%
    mutate(include_good_rt = ifelse(log(rt) > mean(log(rt)) + 2 * sd(log(rt)) |
                                        log(rt) < mean(log(rt)) - 2 * sd(log(rt)),
                                    0, 1))

d.exp_analysis <- d.exp_analysis %>% filter(include_good_rt == 1)
```

## Experiment FYP: Social vs. No-social, Different delays, Different number of referents

Set up filters

```{r filters set up}
d.test_df <- d.test_df %>% 
    filter(include_good_rt == 1)

d.test_df_filt <- d.test_df %>% 
    filter(include_good_rt == 1, 
           include_expo == 1)
```

Get the number of subjects filtered out

```{r num subs filtered out}
#get number of subjects filtered out
df_n <- d.test_df %>%
                  summarise(n_subs = n_distinct(subids))

df_n_filt <- d.test_df_filt %>%
                        summarise(n_subs_filt = n_distinct(subids)) %>%
                        select(n_subs_filt)

cbind(df_n, df_n_filt)
```

Accuracy on exposure trials.

```{r acc exposure, echo=F}
d_expo_expt1 <- d.test_df %>% filter(condition == "Social",
                                     include_good_rt == 1)

ms_exp_looks <-  d_expo_expt1 %>%
    group_by(numPic, intervalNum) %>%
    summarise(accuracy_exposure = mean(correct_exposure),
              ci_low = ci.low(correct_exposure),
              ci_high = ci.high(correct_exposure))
```

Accuracy on exposure trials, comparing experiment 1 and 2.

```{r accuracy exposure expts 1 and 2}
ms_exp_expt1 <- ms_exp_looks %>%
    filter(intervalNum == 0 | intervalNum == 3,
           numPic == 4) %>%
    mutate(expt = "Experiment 1")

## this is from soc-xsit-live script
ms_expo <- ms_expo %>%
    mutate(expt = "Experiment 2", numPic = 4) 

## now join
ms_exp_expt1_2 <- bind_rows(ms_exp_expt1, ms_expo)
```

Now we plot accuracy on exposure trials in experiment 1 vs. experiment 2 

```{r acc exposure trials expt 1 and 2}
ms_exp_expt1_2$intervalNum <- factor(ms_exp_expt1_2$intervalNum)

ggplot(data=ms_exp_expt1_2, 
       aes(x=intervalNum, y=accuracy_exposure, 
           fill = expt)) +
    geom_bar(stat="identity", width=0.5, position=position_dodge()) +
    geom_linerange(aes(ymin=accuracy_exposure - ci_low, 
                       ymax=accuracy_exposure + ci_high), width = .05, size=0.6,
                   position=position_dodge(0.5)) +
    geom_hline(aes(yintercept=1/4), linetype = "dashed") +
    scale_y_continuous(limits=c(0,1)) +
    scale_fill_manual(values=c("#bdbdbd", "#636363")) +
    xlab("Intervening Trials") + 
    ylab("Prop. Choosing Gaze Target") +
    labs(fill = NULL) +
    labs(linetype = "Trial Type") +
    guides(linetype=FALSE) +
    theme(text = element_text(size=12), 
          axis.title.y=element_text(vjust=1),
          axis.title.x=element_text(vjust=-0.3),
          legend.position ="top") 

ggsave("acc-expo-expt1_2.pdf",dpi=600,title="Experiments 1 and 2 Accuracy Exposure",
       path = "/Users/kmacdonald/Documents/Projects/SOC_XSIT/cogsci-2015/plots_figs",
       width=4, height=3.4)
```

Now we need to join the exposure data from experiment 1 and 2 together, 
so we can model the differences. 
```{r munge selecting gaze target expts 1 and 2}
# munge exposure trial data sets so we can merge
# experiment 1
df_exposure1_temp <- d_expo_expt1 %>%
    select(subids, intervalNum, numPic, correct_exposure) %>%
    mutate(expt = "Experiment 1") 

# experiment 2
df_exposure2_temp <- df_exposure %>%
    select(subids, intervalNum, numPic, correct) %>%
    rename(correct_exposure = correct)  %>%
    mutate(expt = "Experiment 2",
           subids = factor(subids))

# now bind together 
df_expo_all <- bind_rows(df_exposure1_temp, df_exposure2_temp)

df_expo_all$subids <- as.factor(df_expo_all$subids)
df_expo_all$expt <- as.factor(df_expo_all$expt)
```

Now model the combined accuracy on exposure trial data

```{r model acc selecting gaze expts 1 and 2}
m1_exp <- glm(correct_exposure ~ expt + intervalNum, 
            data=df_expo_all, family=binomial)

summary(m1_exp)
```


Accuracy on test trials, filtering out subjects who performed below chance on exposure trials.
```{r acc test subject and trial filtering}
ms_test_filt <- d.test_df %>%
    filter(include_good_rt == 1, 
           (condition == "No-Social") | 
               (include_expo == 1 & correct_exposure == TRUE)
           ) %>%
    group_by(condition, intervalNum, numPic, trialType) %>%
    summarise(accuracy = mean(correct),
              ci_low = ci.low(correct),
              ci_high = ci.high(correct),
              exclusionary_criteria = "subject-level")

ms_test_filt$graph.numPic <- factor(ms_test_filt$numPic,
                             labels=c("Two","Four", "Six", "Eight"))
```
Now make a pretty plot 

```{r plot expt1 cogsci}
ggplot(data=ms_test_filt, 
       aes(x=intervalNum, y=accuracy, 
           colour = condition)) + 
    geom_pointrange(aes(ymin=accuracy - ci_low, 
                        ymax=accuracy + ci_high), width = .05, size=0.6) +
    geom_line(aes(linetype = trialType), size=0.4) +
    geom_hline(aes(yintercept=1/numPic), linetype = "dashed") +
    scale_x_continuous(limits=c(-.9,11), breaks=c(0, 1, 3, 7)) +
    scale_y_continuous(limits=c(0,1)) +
    scale_colour_manual(values=c("#1f78b4", "red")) +
    facet_grid( ~ graph.numPic, labeller = mf_labeller) + 
    xlab("Intervening Trials") + 
    ylab("Prop. Choosing Repeated Referent") +
    labs(colour = "Condition") +
    labs(linetype = "Trial Type") +
    guides(linetype=FALSE) +
    theme(text = element_text(size=14), 
          axis.title.y=element_text(vjust=1),
          axis.title.x=element_text(vjust=-0.3),
          legend.justification=c(0,0),
          legend.position = c(0,0)) 

# save
ggsave("acc-test-expt1.pdf",dpi=600,title="Experiments 1 Accuracy",
       path = "/Users/kmacdonald/Documents/Projects/SOC_XSIT/cogsci-2015/plots_figs")
```

Accuracy on test trials, without filtering subjects (only trial level filtering)

```{r acc test trial filtering}
ms_test_looks_unfiltered <- d.test_df %>%
    filter(include_good_rt == 1, 
           condition == "No-Social" | correct_exposure == TRUE) %>%
    group_by(condition, intervalNum, numPicN, trialType) %>%
    summarise(accuracy = mean(correct),
              ci_low = ci.low(correct),
              ci_high = ci.high(correct),
              exclusionary_criteria = "trial-level")

acc_test_2 <- ggplot(data=ms_test_looks_unfiltered, aes(x=intervalNum, y=accuracy, 
                                                        colour = condition)) + 
    geom_line(aes(linetype = trialType)) +
    geom_errorbar(aes(ymin=accuracy - ci_low, 
                      ymax=accuracy + ci_high), width = .1) +
    geom_hline(aes(yintercept=1/numPic), linetype = "dashed") +
    scale_x_continuous(limits=c(-0.5, 7.5), breaks=c(0,1,3,7)) +
    scale_y_continuous(limits=c(0,1)) +
    scale_colour_manual(values=c("firebrick1", "dodgerblue")) +
    facet_grid(. ~ numPic) + 
    xlab("Intervening Trials") + 
    ylab("Proportion Correct") +
    labs(colour = "Condition") +
    labs(linetype = "Trial Type")
```

Model the data

```{r models}
# rt model
m1.rt <- lmer(rt ~ condition * log2(intervalNum + 1) * log2(numPicN) + (1|subids), data=d.exp_analysis)

summary(m1.rt)

ms_rt <- d.exp_analysis %>%
    group_by(condition, intervalNum, numPicN) %>%
    summarise(mean_rt = mean(rt),
              ci_low = ci.low(correct),
              ci_high = ci.high(correct))

qplot(x=intervalNum, y=mean_rt, data=ms_rt, geom=("line"),
      color=condition) + 
    facet_grid(~numPicN)

# extract coefficients
coefs <- data.frame(coef(summary(m1.rt)))

# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

# full model without logs
m1 <- glmer(correct ~ trialType * condition * intervalNum * numPicN + 
                (trialType | subids), 
            data=d.test_df, family=binomial, nAGQ=0)

summary(m1)

# full model using logs 
m1.l <- glmer(correct ~ trialType * condition * 
                log2(intervalNum + 1) * log2(numPicN) + 
                (trialType | subids), 
            data=d.test_df, family=binomial, nAGQ=0)

summary(m1.l)

m1.l2 <- glmer(correct ~ (trialType + condition + 
                            log2(intervalNum + 1) + log2(numPicN))^2 + 
                 (trialType | subids), 
               data=d.test_df, family=binomial, nAGQ=0)

summary(m1.l2)

# 3 ways are just as good as 4 way
m1.l3 <- glmer(correct ~ (trialType + condition + 
                log2(intervalNum + 1) + log2(numPicN))^3 + 
                (trialType | subids), 
              data=d.test_df, family=binomial, nAGQ=0)
summary(m1.l3)
```

Make pretty table for latex

```{r table latex}
e1.tab <- as.data.frame(summary(m1.l2)$coef)

e1.tab$Predictor <- c("Intercept",
                      "Switch Trial",
                      "Social Condition",
                      "Log(Interval)",
                      "Log(Referents)",
                      "Switch Trial*Social Condition",
                      "Switch Trial*Log(Interval)",
                      "Switch Trial*Log(Referent)",
                      "Social Condition*Log(Interval)",
                      "Social Condition*Log(Referent)",
                      "Log(Interval)*Log(Referent)")

rownames(e1.tab) <- NULL
e1.tab <- e1.tab[,c(5,1:4)]
e1.tab$stars <- sapply(e1.tab[,5],getstars)
names(e1.tab)[6] <- ""

names(e1.tab)[4:5] <- c("$z$ value","$p$ value")

print(xtable(e1.tab,
             align = c("l","l","r","r","r","r","l"),
             label = "tab:exp1_reg"),
      include.rownames=FALSE,hline.after=c(0,nrow(e1.tab)),
      sanitize.text.function=function(x){x})

## table for 3 way model
# e1.tab$Predictor <- c("Intercept",
#                       "Switch Trial",
#                       "Social Condition",
#                       "Log(Interval)",
#                       "Log(Referents)",
#                       "Switch Trial*Social Condition",
#                       "Switch Trial*Log(Interval)",
#                       "Switch Trial*Log(Referent)",
#                       "Social Condition*Log(Interval)",
#                       "Social Condition*Log(Referent)",
#                       "Log(Interval)*Log(Referent)",
#                       "Switch Trial*Social Condition*Log(Interval)",
#                       "Switch Trial*Social Condition*Log(Referents)",
#                       "Switch Trial*Log(Interval)*Log(Referents)",
#                       "Social Condition*Log(Interval)*Switch Trial")
```
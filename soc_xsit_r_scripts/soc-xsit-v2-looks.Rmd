---
title: "Social Cross-Situational Word Learning"
author: "Kyle MacDonald & Allison Dods"
date: "July 14, 2014"
output: html_document
---

#### Analysis code for SOC-XSIT project. 

Load libraries.

```{r load libraries, message=FALSE, warning=FALSE}
library(reshape)
library(plyr)
library(dplyr)
library(bootstrap)
library(lme4)
library(ggplot2)
source("/Users/kmacdonald/Documents/Projects/SOC_XSIT/XSIT-MIN/analysis/Ranalysis/useful.R")
```

Read in the master data file

```{r read in data}
setwd("/Users/kmacdonald/Documents/Projects/SOC_XSIT/processed_data/adult-looks/")
d.all_df <- read.csv("soc_xsit_data_all.csv")
```

#### Get the number of subjects in each experiment and condition.

```{r get number of subs, echo=FALSE}
d.all_df %>%
      group_by(experiment, condition, gazeLength) %>%
      summarise(n_subs = n_distinct(subids))
```


#### Flag whether participants chose target of eye gaze on exposure. 

```{r flag chose eye gaze trials}
#change values of faceIdx to correspond to values of chosenIdx 
#(LU = 0, RU = 1, LD = 2, RD = 3, striaight = -1)
d.all_df$faceIdx <- revalue(d.all_df$face, 
                         c("silentLUlong"= 0, "silentLUmedium" = 0,
                           "silentLUshort"= 0, "LUkidslonger" = 0,
                           "silentRUlong" = 1, "silentRUmedium"= 1,
                           "silentRUshort" = 1, "RUkidslonger" = 1,
                           "silentLDlong" = 2, "silentLDmedium" = 2,
                           "silentLDshort" = 2, "LDkidslonger" = 2,
                           "silentRDlong" = 3, "silentRDmedium" = 3,
                           "silentRDshort" = 3, "RDkidslonger" = 3, 
                           "straightahead" = -1, "straightaheadlonger" = -1))

#flag trial, if subs chose target of gaze
d.expo_df <- d.all_df %>%
                filter(exposure_trial == 1) %>%
                mutate(correct_exposure = faceIdx == chosenIdx) %>%
                select(subids, itemNum, correct_exposure)
```

#### Get test trials and merge exposure trial information. 

```{r test trials w/exposure}
d.test_df <- d.all_df %>%
                filter(test_trial == 1)

d.test_df <- merge(d.expo_df, d.test_df, by = c("subids", "itemNum"))
```

Flag subs who got <25% of exposure trials correct. This can be used for exclusionary criteria in later analyses. 

```{r all data flag subs <25% correct on exposure}
d.test_df <- d.test_df %>%
                group_by(subids) %>%
                summarise(mean_acc_exp = mean(correct_exposure)) %>%
                mutate(include_expo = ifelse(mean_acc_exp > 0.25,1,0)) %>%
                join(d.test_df, by = "subids")
```

Flag trials with extremely slow or fast RTs (+/- 2SD).

```{r all data clean RTs}
d.test_df <- d.test_df %>%
                mutate(include_good_rt = ifelse(log(rt) > mean(log(rt)) + 2 * sd(log(rt)) |
                                                log(rt) < mean(log(rt)) - 2 * sd(log(rt)),
                                                0,1))
```

### Summarize data set: means for acc on exposure and test

#### Experiment 1: Look-length manipulation. 

Filter data and output the number of subjects removed in each condition based on filtering

```{r gaze-length filter}
glength_df <- filter(d.test_df, experiment == "look_length", 
                   include_good_rt == 1)

glength_filt_df <- filter(d.test_df, experiment == "look_length", 
                   include_good_rt == 1, include_expo == 1)

#get number of subjects filtered out
glength_n <- d.test_df %>%
                  filter(experiment == "look_length") %>%
                  group_by(gazeLength) %>%
                  summarise(n_subs = n_distinct(subids))

glength_n_filtered <- glength_filt_df %>%
                        filter(experiment == "look_length") %>%
                        group_by(gazeLength) %>%
                        summarise(n_subs_filt = n_distinct(subids)) %>%
                        select(n_subs_filt)
                  
cbind(glength_n, glength_n_filtered)
```

Accuracy on exposure trials both filtered and unfiltered.

```{r look-length exposure}
ms_exp_looks <- glength_df %>%
                        group_by(gazeLength) %>%
                        summarise(accuracy_exposure = mean(correct_exposure),
                                  ci_low = ci.low(correct_exposure),
                                  ci_high = ci.high(correct_exposure))

ms_exp_looks_filt <- glength_filt_df %>%
                        group_by(gazeLength) %>%
                        summarise(accuracy_exposure = mean(correct_exposure),
                                  ci_low = ci.low(correct_exposure),
                                  ci_high = ci.high(correct_exposure))

ms_exp_looks$gazeLength <- factor(ms_exp_looks$gazeLength, 
                                  levels = c("Short", "Medium", "Long"))
ms_exp_looks_filt$gazeLength <- factor(ms_exp_looks_filt$gazeLength, 
                                  levels = c("Short", "Medium", "Long"))

glen_acc_exp <- ggplot(data=ms_exp_looks, 
                   aes(x=gazeLength, y=accuracy_exposure,
                       fill=gazeLength)) + 
                    geom_bar(stat="identity") +
                    geom_pointrange(aes(ymin=accuracy_exposure-ci_low, 
                                  ymax=accuracy_exposure+ci_high), width = .1) +
                    geom_hline(yintercept=0.25, linetype = "dashed") +
                    scale_y_continuous(limits=c(0,1)) +
                    ggtitle("Unfiltered")

glen_acc_exp_filt <- ggplot(data=ms_exp_looks_filt, 
                               aes(x=gazeLength, y=accuracy_exposure,
                                   fill=gazeLength)) + 
                                geom_bar(stat="identity") +
                                geom_pointrange(aes(ymin=accuracy_exposure-ci_low, 
                                              ymax=accuracy_exposure+ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1))+
                                ggtitle("Filtered")

multiplot(glen_acc_exp, glen_acc_exp_filt, cols=2)
```

Accuracy on test trials: same/switch. For both filtered and unfiltered.

```{r look-length acc test}
ms_test_looks <- glength_df %>%
                        group_by(gazeLength, trialType) %>%
                        summarise(accuracy = mean(correct),
                                  ci_low = ci.low(correct),
                                  ci_high = ci.high(correct))

ms_test_looks_filt <- glength_filt_df %>%
                              group_by(gazeLength, trialType) %>%
                              summarise(accuracy = mean(correct),
                                        ci_low = ci.low(correct),
                                        ci_high = ci.high(correct))

ms_test_looks$gazeLength <- factor(ms_test_looks$gazeLength, 
                                  levels = c("Short", "Medium", "Long"))

ms_test_looks_filt$gazeLength <- factor(ms_test_looks_filt$gazeLength, 
                                  levels = c("Short", "Medium", "Long"))

glen_acc_test <- ggplot(ms_test_looks, 
                         aes(x=gazeLength, y=accuracy, 
                             group=trialType, colour=trialType)) +
                          geom_point(size=2) +
                          geom_line() +
                          geom_pointrange(aes(ymin=accuracy - ci_low,
                                            ymax=accuracy + ci_high), width = .1) +
                          geom_hline(yintercept=0.25, linetype = "dashed") +
                          scale_y_continuous(limits=c(0,1)) +
                          ggtitle("Acc Test Unfiltered")

glen_acc_test_filt <- ggplot(ms_test_looks_filt, 
                         aes(x=gazeLength, y=accuracy, 
                             group=trialType, colour=trialType)) +
                          geom_point(size=2) +
                          geom_line() +
                          geom_pointrange(aes(ymin=accuracy - ci_low,
                                            ymax=accuracy + ci_high), width = .1) +
                          geom_hline(yintercept=0.25, linetype = "dashed") +
                          scale_y_continuous(limits=c(0,1)) +
                          ggtitle("Acc Test Filtered")

multiplot(glen_acc_test, glen_acc_test_filt, cols=2)
```


#### Experiment 2: Social vs. No-Social between subjects. 

Only used the short gaze length condition.

First, set up filters. 

```{r between subjects filters}
btw_subs_df <- filter(d.test_df, experiment == "soc_vs_no_soc_btw", 
                   include_good_rt == 1)

btw_subs_filt_df <- filter(d.test_df, experiment == "soc_vs_no_soc_btw", 
                   include_good_rt == 1, include_expo == 1 | condition == "No-social")

#get number of subjects filtered out
btw_subs_n <- d.test_df %>%
                  filter(experiment == "soc_vs_no_soc_btw") %>%
                  group_by(condition) %>%
                  summarise(n_subs = n_distinct(subids))

btw_subs_n_filtered <- btw_subs_filt_df %>%
                        filter(experiment == "soc_vs_no_soc_btw") %>%
                        group_by(condition) %>%
                        summarise(n_subs_filt = n_distinct(subids)) %>%
                        select(n_subs_filt)
                  
cbind(btw_subs_n, btw_subs_n_filtered)
```


### Accuracy on exposure trials.

```{r between subs exposure}
ms_exp_btw <- btw_subs_df %>%
                        filter(condition == "Social") %>%
                        summarise(accuracy_exposure = mean(correct_exposure),
                                  ci_low = ci.low(correct_exposure),
                                  ci_high = ci.high(correct_exposure)) %>%
                        mutate(filtering = "unfiltered")

ms_exp_btw_filt <- btw_subs_filt_df %>%
                        filter(condition == "Social") %>%
                        summarise(accuracy_exposure = mean(correct_exposure),
                                  ci_low = ci.low(correct_exposure),
                                  ci_high = ci.high(correct_exposure)) %>%
                        mutate(filtering = "filtered")

ms_exp_btw_bind <- rbind(ms_exp_btw, ms_exp_btw_filt)

qplot(data=ms_exp_btw_bind, x=filtering, y=accuracy_exposure, fill=filtering) +
                                geom_bar(stat="identity") +
                                geom_pointrange(aes(ymin=accuracy_exposure-ci_low, 
                                              ymax=accuracy_exposure+ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1))
```

### Accuracy on test trials

```{r between subs test}
ms_test_btw <- btw_subs_df %>%
                        group_by(condition, trialType) %>%
                        summarise(accuracy_test = mean(correct),
                                  ci_low = ci.low(correct),
                                  ci_high = ci.high(correct))

ms_test_btw_filt <- btw_subs_filt_df %>%
                        group_by(condition, trialType) %>%
                        summarise(accuracy_test = mean(correct),
                                  ci_low = ci.low(correct),
                                  ci_high = ci.high(correct))

ms_test_btw$condition <- factor(ms_test_btw$condition, 
                                         levels = c("Social", "No-social"))
ms_test_btw_filt$condition <- factor(ms_test_btw_filt$condition, 
                                         levels = c("Social", "No-social"))

#now plot
acc_test_btw <- ggplot(ms_test_btw, 
                               aes(x=condition, y=accuracy_test, 
                                   group=trialType, colour=trialType)) +
                                geom_point(size=2.5) +
                                geom_line() +
                                geom_pointrange(aes(ymin=accuracy_test - ci_low,
                                                  ymax=accuracy_test + ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1)) +
                                xlab("Condition") +
                                ylab("Proportion Correct") +
                                labs(colour = "Trial Type") +
                                ggtitle("Between-Subs (Smile) Unfiltered")

acc_test_btw_filt <- ggplot(ms_test_btw_filt, 
                               aes(x=condition, y=accuracy_test, 
                                   group=trialType, colour=trialType)) +
                                geom_point(size=2.5) +
                                geom_line() +
                                geom_pointrange(aes(ymin=accuracy_test - ci_low,
                                                  ymax=accuracy_test + ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1)) +
                                xlab("Condition") +
                                ylab("Proportion Correct") +
                                labs(colour = "Trial Type") +
                                ggtitle("Between-Subs (Smiley) Filtered")

multiplot(acc_test_btw, acc_test_btw_filt, cols=2)
```

Model the data.

```{r soc-no-soc model random slope}
inc.data <- filter(d.test_df, experiment == "soc_vs_no_soc_btw", 
                               include_good_rt == 1,
                               include_expo == 1 | condition == "No-social")
m1 <- glmer(correct ~ trialType * condition + (trialType | subids),
            data = inc.data,
            family=binomial)
summary(m1)
```

```{r explore model}
ms <- aggregate(correct ~ trialType + condition, FUN=mean,
          data = inc.data)

f <- fixef(m1)
ms$coef <- NA
ms$coef[1] <- inv.logit(f[1])
ms$coef[2] <- inv.logit(f[1] + f[2])
ms$coef[3] <- inv.logit(f[1] + f[3])
ms$coef[4] <- inv.logit(f[1] + f[2] + f[3] + f[4])
```

```{r look at individual participant data}
hist(ranef(m1)$subids[,1])
hist(ranef(m1)$subids[,2])

mss <- aggregate(correct ~ subids + trialType + condition, FUN=mean,
          data = inc.data)

cmss <- cast(mss, condition+ subids ~  trialType)

qplot(Same,Switch, data=cmss, position="jitter") + 
      facet_wrap(~condition)
```

```{r glm btw-exp}
lm1 <- glm(correct ~ trialType * condition,
            data = inc.data,
            family=binomial)
summary(lm1) 
f <- coef(lm1)
ms$lcoef <- NA
ms$lcoef[1] <- inv.logit(f[1])
ms$lcoef[2] <- inv.logit(f[1] + f[2])
ms$lcoef[3] <- inv.logit(f[1] + f[3])
ms$lcoef[4] <- inv.logit(f[1] + f[2] + f[3] + f[4])

```


```{r soc-no-soc model random intercept}
m2 <- glmer(correct ~ trialType * condition + (1 | subids),
            data = inc.data,
            family=binomial)
f <- fixef(m2)
ms$m2coef <- NA
ms$m2coef[1] <- inv.logit(f[1])
ms$m2coef[2] <- inv.logit(f[1] + f[2])
ms$m2coef[3] <- inv.logit(f[1] + f[3])
ms$m2coef[4] <- inv.logit(f[1] + f[2] + f[3] + f[4])
summary(m2)
anova(m1,m2)
```

model with simple linear model -- do not use, just for kicks

```{r lm btw}
summary(lm(correct ~ condition * trialType, data=mss))
```

#### Experiment 3: Within Subjects Social vs. No-social 

Replicate the social effect on switch trials with a within-subjects manipulation. 
This allows us to make stronger inferences about the difference between conditions 
because there is less between subjects variability.

Filter just trials from within-subjects experiment.

```{r within subs experiment}
d_within_df <- filter(d.all_df, experiment == "soc_vs_no_soc_within")

d_within_df %>%
      group_by(condition) %>%
      summarise(n_subs = n_distinct(subids))
```

### Flag social vs. no-social trials

When we switched to within subjects, we tracked which block came first, but didn't 
track social vs. no-social. So we create a column to track this information

```{r flag social_trial_type within subs}
d_within_df <- d_within_df %>%
                  mutate(condition_trial = ifelse(condition == "No-socialFirst" 
                                                  & itemNum <= 7, "no-social", 
                                            ifelse(condition == "SocialFirst" 
                                                   & itemNum <= 7, "social", 
                                                   ifelse(condition == "No-socialFirst" 
                                                          & itemNum >= 8, "social",
                                                          ifelse(condition == "SocialFirst" 
                                                                 & itemNum >= 8, 
                                                                 "no-social", NA)))))
#flag trial, if subs chose target of gaze
d_within_expo_df <- d_within_df %>%
                        filter(exposure_trial == 1) %>%
                        mutate(correct_exposure = faceIdx == chosenIdx) %>%
                        select(subids, itemNum, correct_exposure)

#grab test trials
d_within_test_df <- d_within_df %>%
                        filter(test_trial == 1)

#merge with test trials
d_within_test_df <- join(d_within_test_df, d_within_expo_df, c("subids", "itemNum"))
```

Flag subs who got <25% of exposure trials correct. This can be used for exclusionary criteria in later analyses. 

```{r within subs flag subs <25% correct on exposure}
d_within_soc_df <- filter(d_within_test_df, condition_trial == "social")

d_within_soc_df <- d_within_soc_df %>%
                            group_by(subids) %>%
                            summarise(mean_acc_exp = mean(correct_exposure)) %>%
                            mutate(include_expo = ifelse(mean_acc_exp > 0.25,1,0)) 
                            
d_within_test_df <- join(d_within_test_df, d_within_soc_df, by = "subids")
```

Flag trials with extremely slow or fast RTs (+/- 2SD).

```{r within subs clean RTs}
d_within_test_df <- d_within_test_df %>%
                        mutate(include_good_rt = ifelse(log(rt) > mean(log(rt)) + 2 * sd(log(rt)) |
                                                              log(rt) < mean(log(rt)) - 2 * sd(log(rt)),
                                                        0,1))
```

Set up filters 

```{r within-subs filters}
d_within_expo <- filter(d_within_test_df,
                        include_good_rt == 1, 
                        condition_trial == "social")


d_within_expo_filt <- filter(d_within_test_df,
                        include_good_rt == 1, include_expo == 1, 
                               condition_trial == "social")
```

Get the number of subjects filtered out

```{r within subs filter subjects}
#get number of subjects filtered out
within_n<- d_within_expo %>%
                  summarise(n_subs = n_distinct(subids))

within_n_filt <- d_within_expo_filt %>%
                        summarise(n_subs_filt = n_distinct(subids)) %>%
                        select(n_subs_filt)
                  
cbind(within_n, within_n_filt)
```

### Accuracy on exposure trials

```{r within subs acc exposure, fig.width=10, fig.height=6}
ms_expo_within <- d_within_expo %>%
                        group_by(condition, condition_trial) %>%
                        summarise(accuracy_exposure = mean(correct_exposure),
                                  ci_low = ci.low(correct_exposure),
                                  ci_high = ci.high(correct_exposure))

ms_expo_within_filt <- d_within_expo_filt %>%
                              group_by(condition, condition_trial) %>%
                              summarise(accuracy_exposure = mean(correct_exposure),
                                        ci_low = ci.low(correct_exposure),
                                        ci_high = ci.high(correct_exposure))

ms_expo_within$condition <- factor(ms_expo_within$condition)
ms_expo_within_filt$condition <- factor(ms_expo_within_filt$condition)

acc_exp_within <- ggplot(data=ms_expo_within, 
                         aes(x=condition, y=accuracy_exposure,
                             fill=condition)) + 
                          geom_bar(stat="identity") +
                          geom_pointrange(aes(ymin=accuracy_exposure-ci_low, 
                                        ymax=accuracy_exposure+ci_high), width = .1) +
                          geom_hline(yintercept=0.25, linetype = "dashed") +
                          scale_y_continuous(limits=c(0,1)) +
                          ggtitle("Acc Exposure Unfiltered")

acc_exp_within_filt <- ggplot(data=ms_expo_within_filt, 
                         aes(x=condition, y=accuracy_exposure,
                             fill=condition)) + 
                          geom_bar(stat="identity") +
                          geom_pointrange(aes(ymin=accuracy_exposure-ci_low, 
                                        ymax=accuracy_exposure+ci_high), width = .1) +
                          geom_hline(yintercept=0.25, linetype = "dashed") +
                          scale_y_continuous(limits=c(0,1)) +
                          ggtitle("Acc Exposure Filtered")

multiplot(acc_exp_within, acc_exp_within_filt, cols=2)
```

```{r explore within individual data}
#Apply different filters
sub_level_filter <- filter(d_within_test_df,
                           include_good_rt == 1, include_expo == 1,
                               condition_trial == "social")

trial_level_filter <- filter(d_within_test_df,
                           include_good_rt == 1, condition_trial == "social")


mss_expo_within_sub_lev <- sub_level_filter %>%
                              group_by(condition, condition_trial, subids) %>%
                              summarise(accuracy_exposure = mean(correct_exposure))

mss_expo_within_trial_lev <- trial_level_filter %>%
                                    group_by(condition, condition_trial, subids) %>%
                                    summarise(accuracy_exposure = mean(correct_exposure))


sub_hist <- qplot(accuracy_exposure, geom="bar",
                  facets=.~condition, data=mss_expo_within_sub_lev)

trial_hist <- qplot(accuracy_exposure, geom="bar",
                  facets=.~condition, data=mss_expo_within_trial_lev)

trial_hist
```

```{r explore ind subs data}
dss <- d_within_test_df %>% filter(include_good_rt == 1, 
                                   include_expo == 1, 
                                   condition_trial == "social") %>%
      group_by(condition, condition_trial, trial.num) %>%
      summarise(accuracy_exposure = mean(correct_exposure))

qplot(trial.num, accuracy_exposure, col=condition, facets=.~condition, 
      geom=c("point","line"),
      data=dss) +
      scale_y_continuous(limits=c(0,1))
```

#### Accuracy on test trials within subjects experiment 

```{r accuracy on test within subs}
#Set up filters
inc.data.within_sub_level <- filter(d_within_test_df, include_good_rt == 1, include_expo == 1)

inc.data.within_trial_level <- filter(d_within_test_df, include_good_rt == 1 & 
                                    correct_exposure == TRUE | condition_trial == "no-social")

inc.data.within_unfilt <- filter(d_within_test_df, include_good_rt == 1)
```

Test accuracy computations with different filters.

```{r within subs test acc computations}
##Subject level
ms_test_within_sub_level <- inc.data.within_sub_level %>%
                                          group_by(condition, condition_trial, trialType) %>%
                                          summarise(accuracy = mean(correct),
                                                ci_low = ci.low(correct),
                                                ci_high = ci.high(correct))

ms_test_within_sub_level$condition <- factor(ms_test_within_sub_level$condition)
ms_test_within_sub_level$condition_trial <- factor(ms_test_within_sub_level$condition_trial, 
                                         levels = c("social", "no-social"))

acc_test_within_blocks_sub_level <- ggplot(ms_test_within_sub_level, 
                                     aes(x=condition_trial, y=accuracy, 
                                         group=trialType, colour=trialType)) +
                                      geom_point(size=2) +
                                      geom_line() +
                                      geom_pointrange(aes(ymin=accuracy - ci_low,
                                                        ymax=accuracy + ci_high), width = .1) +
                                      geom_hline(yintercept=0.25, linetype = "dashed") +
                                      scale_y_continuous(limits=c(0,1)) +
                                      facet_wrap(~condition) + 
                                      ggtitle("Within-subs Subject-level")

##Trial level
ms_test_within_trial_level <- inc.data.within_trial_level %>%
                                          group_by(condition, condition_trial, trialType) %>%
                                          summarise(accuracy = mean(correct),
                                                ci_low = ci.low(correct),
                                                ci_high = ci.high(correct))

ms_test_within_trial_level$condition <- factor(ms_test_within_trial_level$condition)
ms_test_within_trial_level$condition_trial <- factor(ms_test_within_trial_level$condition_trial, 
                                         levels = c("social", "no-social"))

acc_test_within_blocks_trial_level <- ggplot(ms_test_within_trial_level, 
                                           aes(x=condition_trial, y=accuracy, 
                                               group=trialType, colour=trialType)) +
                                            geom_point(size=2) +
                                            geom_line() +
                                            geom_pointrange(aes(ymin=accuracy - ci_low,
                                                              ymax=accuracy + ci_high), width = .1) +
                                            geom_hline(yintercept=0.25, linetype = "dashed") +
                                            scale_y_continuous(limits=c(0,1)) +
                                            facet_wrap(~condition) + 
                                            ggtitle("Within-subs-Trial-Level")

##Unfiltered
ms_test_within_unfilt <- inc.data.within_unfilt %>%
                                          group_by(condition, condition_trial, trialType) %>%
                                          summarise(accuracy = mean(correct),
                                                ci_low = ci.low(correct),
                                                ci_high = ci.high(correct))

ms_test_within_unfilt$condition <- factor(ms_test_within_unfilt$condition)
ms_test_within_unfilt$condition_trial <- factor(ms_test_within_unfilt$condition_trial, 
                                         levels = c("social", "no-social"))

acc_test_within_blocks_unfilt <- ggplot(ms_test_within_unfilt, 
                                           aes(x=condition_trial, y=accuracy, 
                                               group=trialType, colour=trialType)) +
                                            geom_point(size=2) +
                                            geom_line() +
                                            geom_pointrange(aes(ymin=accuracy - ci_low,
                                                              ymax=accuracy + ci_high), width = .1) +
                                            geom_hline(yintercept=0.25, linetype = "dashed") +
                                            scale_y_continuous(limits=c(0,1)) +
                                            facet_wrap(~condition) + 
                                            ggtitle("Within-subs Unfiltered")

multiplot(acc_test_within_blocks_sub_level, acc_test_within_blocks_trial_level, 
          acc_test_within_blocks_unfilt, cols = 2)
```

Now do the same accuracy computation but collapse across blocks

```{r acc test collapse blocks, fig.width=10, fig.height=6}
#Computations 
ms_test_within_collapse <- inc.data.within_sub_level %>%
                                    group_by(condition_trial, trialType) %>%
                                    summarise(accuracy = mean(correct),
                                              ci_low = ci.low(correct),
                                              ci_high = ci.high(correct))

ms_test_within_collapse_trial <- inc.data.within_trial_level %>%
                                          group_by(condition_trial, trialType) %>%
                                          summarise(accuracy = mean(correct),
                                                    ci_low = ci.low(correct),
                                                    ci_high = ci.high(correct))

ms_test_within_collapse_unfilt <- inc.data.within_unfilt %>%
                                          group_by(condition_trial, trialType) %>%
                                          summarise(accuracy = mean(correct),
                                                    ci_low = ci.low(correct),
                                                    ci_high = ci.high(correct))
#refactor things for plotting
ms_test_within_collapse$condition_trial <- factor(ms_test_within_collapse$condition_trial,
                                                  levels = c("social", "no-social"))

ms_test_within_collapse_trial$condition_trial <- factor(ms_test_within_collapse_trial$condition_trial,
                                                  levels = c("social", "no-social"))

ms_test_within_collapse_unfilt$condition_trial <- factor(ms_test_within_collapse_unfilt$condition_trial,
                                                  levels = c("social", "no-social"))

#now plot
acc_test_within_sub <- ggplot(ms_test_within_collapse, 
                               aes(x=condition_trial, y=accuracy, 
                                   group=trialType, colour=trialType)) +
                                geom_point(size=2) +
                                geom_line() +
                                geom_pointrange(aes(ymin=accuracy - ci_low,
                                                  ymax=accuracy + ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1)) +
                                ggtitle("Within-subs Subject Filter")

acc_test_within_trial <- ggplot(ms_test_within_collapse_trial, 
                               aes(x=condition_trial, y=accuracy, 
                                   group=trialType, colour=trialType)) +
                                geom_point(size=2) +
                                geom_line() +
                                geom_pointrange(aes(ymin=accuracy - ci_low,
                                                  ymax=accuracy + ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1)) +
                                ggtitle("Within-subs Trial Filter")

acc_test_within_unfilt <- ggplot(ms_test_within_collapse_unfilt, 
                               aes(x=condition_trial, y=accuracy, 
                                   group=trialType, colour=trialType)) +
                                geom_point(size=2) +
                                geom_line() +
                                geom_pointrange(aes(ymin=accuracy - ci_low,
                                                  ymax=accuracy + ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1)) +
                                ggtitle("Within-subs Unfiltered")

multiplot(acc_test_within_sub, acc_test_within_trial, acc_test_within_unfilt, cols=2)
```

##### Model the within subs data

```{r model within subs}
m1_within <- glmer(correct ~ trialType * condition_trial + (trialType | subids),
            data = inc.data.within_trial_level,
            family=binomial)
summary(m1_within)

m1_within_unfilt <- glmer(correct ~ trialType * condition_trial + (trialType | subids),
            data = inc.data.within_unfilt,
            family=binomial)
summary(m1_within_unfilt)
```

### Experiment #5 Within-subjects replication 

Goal is to replicate the dip in accuracy on same trials in the no-social condition because this effect only came out in the first within-subs experiment.

Filter just trials from within-subjects  experiment.

```{r filter within subs replication}
d_within_rep_df <- filter(d.all_df, experiment == "within_replication")

d_within_rep_df %>%
      group_by(condition) %>%
      summarise(n_subs = n_distinct(subids))
```

### Flag social vs. no-social trials

When we switched to within subjects, we tracked which block came first, but didn't 
track social vs. no-social. So we create a column to track this information

```{r flag social_trial_type within subs replication}
d_within_rep_df <- d_within_rep_df %>%
                  mutate(condition_trial = ifelse(condition == "No-socialFirst" 
                                                  & trial.num <= 20, "no-social", 
                                            ifelse(condition == "SocialFirst" 
                                                   & trial.num <= 20, "social", 
                                                   ifelse(condition == "No-socialFirst" 
                                                          & trial.num >= 21, "social",
                                                          ifelse(condition == "SocialFirst" 
                                                                 & trial.num >= 21, 
                                                                 "no-social", NA)))))
#flag trial, if subs chose target of gaze
d_within_rep_expo_df <- d_within_rep_df %>%
                        filter(exposure_trial == 1) %>%
                        mutate(correct_exposure = faceIdx == chosenIdx) %>%
                        select(subids, itemNum, correct_exposure)

#grab test trials
d_within_rep_test_df <- d_within_rep_df %>%
                        filter(test_trial == 1)

#merge with test trials
d_within_rep_test_df <- join(d_within_rep_test_df, d_within_rep_expo_df, c("subids", "itemNum"))
```

Flag subs who got <25% of exposure trials correct. This can be used for exclusionary criteria in later analyses. 

```{r within subs replication flag subs <25% correct on exposure}
d_within_rep_test_df <- d_within_rep_test_df %>%
                            filter(condition_trial == "social") %>%
                            group_by(subids) %>%
                            summarise(mean_acc_exp = mean(correct_exposure)) %>%
                            mutate(include_expo = ifelse(mean_acc_exp > 0.25,1,0)) %>%
                            join(d_within_rep_test_df, by = "subids")
```

Flag trials with extremely slow or fast RTs (+/- 2SD).

```{r within subs replication clean RTs}
d_within_rep_test_df <- d_within_rep_test_df %>%
                        mutate(include_good_rt = ifelse(log(rt) > mean(log(rt)) + 2 * sd(log(rt)) |
                                                              log(rt) < mean(log(rt)) - 2 * sd(log(rt)),
                                                        0,1))
```


#### Set up filters 

```{r within-subs replication filters}
d_within_expo_rep <- filter(d_within_rep_test_df,
                        include_good_rt == 1, 
                        condition_trial == "social")


d_within_expo_rep_filt <- filter(d_within_rep_test_df,
                        include_good_rt == 1, include_expo == 1, 
                               condition_trial == "social")
```

Get number of subjects filtered out by subject level filtering process

```{r within subs replication filtering process}
#get number of subjects filtered out
within_n_rep<- d_within_expo_rep %>%
                  summarise(n_subs = n_distinct(subids))

within_n_filt_rep <- d_within_expo_rep_filt %>%
                        summarise(n_subs_filt = n_distinct(subids)) %>%
                        select(n_subs_filt)
                  
cbind(within_n_rep, within_n_filt_rep)
```


### Within subs replication: Accuracy on exposure trials

```{r within subs replication acc exposure, fig.width=10, fig.height=6}
ms_expo_within_rep <-  d_within_expo_rep %>%
                              group_by(condition, condition_trial) %>%
                              summarise(accuracy_exposure = mean(correct_exposure),
                                        ci_low = ci.low(correct_exposure),
                                        ci_high = ci.high(correct_exposure))

ms_expo_within_rep_filt <- d_within_expo_rep_filt %>%
                              group_by(condition, condition_trial) %>%
                              summarise(accuracy_exposure = mean(correct_exposure),
                                        ci_low = ci.low(correct_exposure),
                                        ci_high = ci.high(correct_exposure))
#factor for plotting
ms_expo_within_rep$condition <- factor(ms_expo_within_rep$condition)
ms_expo_within_rep_filt$condition <- factor(ms_expo_within_rep_filt$condition)

acc_expo_within_rep <- ggplot(data=ms_expo_within_rep, 
                                     aes(x=condition, y=accuracy_exposure,
                                         fill=condition)) + 
                                      geom_bar(stat="identity") +
                                      geom_pointrange(aes(ymin=accuracy_exposure-ci_low, 
                                                    ymax=accuracy_exposure+ci_high), width = .1) +
                                      geom_hline(yintercept=0.25, linetype = "dashed") +
                                      scale_y_continuous(limits=c(0,1)) +
                                      ggtitle("Within-subs Replication Unfiltered")

acc_expo_within_rep_filt <- ggplot(data=ms_expo_within_rep_filt, 
                                     aes(x=condition, y=accuracy_exposure,
                                         fill=condition)) + 
                                      geom_bar(stat="identity") +
                                      geom_pointrange(aes(ymin=accuracy_exposure-ci_low, 
                                                    ymax=accuracy_exposure+ci_high), width = .1) +
                                      geom_hline(yintercept=0.25, linetype = "dashed") +
                                      scale_y_continuous(limits=c(0,1)) +
                                      ggtitle("Within-subs Replication Filtered")

multiplot(acc_expo_within_rep, acc_expo_within_rep_filt, cols=2)
```


#### Accuracy on test trials within subjects experiment 

```{r accuracy on test within subs replication}
#subject filter
inc.data.within_rep_sub_level <- filter(d_within_rep_test_df, include_good_rt == 1, include_expo == 1 & 
                                    correct_exposure == TRUE | condition_trial == "no-social")
#trial filter
inc.data.within_rep_trial_level <- filter(d_within_rep_test_df, include_good_rt == 1 & 
                                    correct_exposure == TRUE | condition_trial == "no-social")

#unfiltered
inc.data.within_rep_unfilt <- filter(d_within_rep_test_df, include_good_rt == 1)

#accuracy computations
ms_test_within_rep_sub_level <- inc.data.within_rep_sub_level %>%
                                          group_by(condition, condition_trial, trialType) %>%
                                          summarise(accuracy = mean(correct),
                                                ci_low = ci.low(correct),
                                                ci_high = ci.high(correct))

ms_test_within_rep_sub_level$condition <- factor(ms_test_within_rep_sub_level$condition)
ms_test_within_rep_sub_level$condition_trial <- factor(ms_test_within_rep_sub_level$condition_trial, 
                                         levels = c("social", "no-social"))

acc_test_within_rep_blocks_sub_level <- ggplot(ms_test_within_rep_sub_level, 
                                     aes(x=condition_trial, y=accuracy, 
                                         group=trialType, colour=trialType)) +
                                      geom_point(size=2) +
                                      geom_line() +
                                      geom_pointrange(aes(ymin=accuracy - ci_low,
                                                        ymax=accuracy + ci_high), width = .1) +
                                      geom_hline(yintercept=0.25, linetype = "dashed") +
                                      scale_y_continuous(limits=c(0,1)) +
                                      facet_wrap(~condition) + 
                                      ggtitle("Within-subs Replication Subject Level")

ms_test_within_rep_trial_level <- inc.data.within_rep_trial_level %>%
                                          group_by(condition, condition_trial, trialType) %>%
                                          summarise(accuracy = mean(correct),
                                                ci_low = ci.low(correct),
                                                ci_high = ci.high(correct))

ms_test_within_rep_trial_level$condition <- factor(ms_test_within_rep_trial_level$condition)
ms_test_within_rep_trial_level$condition_trial <- factor(ms_test_within_rep_trial_level$condition_trial, 
                                         levels = c("social", "no-social"))

acc_test_within_rep_blocks_trial_level <- ggplot(ms_test_within_trial_level, 
                                           aes(x=condition_trial, y=accuracy, 
                                               group=trialType, colour=trialType)) +
                                            geom_point(size=2) +
                                            geom_line() +
                                            geom_pointrange(aes(ymin=accuracy - ci_low,
                                                              ymax=accuracy + ci_high), width = .1) +
                                            geom_hline(yintercept=0.25, linetype = "dashed") +
                                            scale_y_continuous(limits=c(0,1)) +
                                            facet_wrap(~condition) + 
                                            ggtitle("Within-subs Replication blocks")

multiplot(acc_test_within_rep_blocks_sub_level, acc_test_within_rep_blocks_trial_level)
```

Now do the same accuracy computation but collapse across blocks

```{r within subs replication acc test collapse blocks}
ms_test_within_rep_collapse_sub <- inc.data.within_rep_sub_level %>%
                                    group_by(condition_trial, trialType) %>%
                                    summarise(accuracy = mean(correct),
                                              ci_low = ci.low(correct),
                                              ci_high = ci.high(correct))

ms_test_within_rep_collapse_trial <- inc.data.within_rep_trial_level %>%
                                    group_by(condition_trial, trialType) %>%
                                    summarise(accuracy = mean(correct),
                                              ci_low = ci.low(correct),
                                              ci_high = ci.high(correct))

ms_test_within_rep_collapse_unfilt <- inc.data.within_rep_unfilt %>%
                                    group_by(condition_trial, trialType) %>%
                                    summarise(accuracy = mean(correct),
                                              ci_low = ci.low(correct),
                                              ci_high = ci.high(correct))



ms_test_within_rep_collapse_sub$condition_trial <- factor(ms_test_within_rep_collapse_sub$condition_trial,
                                                  levels = c("social", "no-social"))
ms_test_within_rep_collapse_trial$condition_trial <- factor(ms_test_within_rep_collapse_trial$condition_trial,
                                                  levels = c("social", "no-social"))
ms_test_within_rep_collapse_unfilt$condition_trial <- factor(ms_test_within_rep_collapse_unfilt$condition_trial,
                                                  levels = c("social", "no-social"))

# subject filter
acc_test_within_rep_sub <- ggplot(ms_test_within_rep_collapse_sub, 
                               aes(x=condition_trial, y=accuracy, 
                                   group=trialType, colour=trialType)) +
                                geom_point(size=2) +
                                geom_line() +
                                geom_pointrange(aes(ymin=accuracy - ci_low,
                                                  ymax=accuracy + ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1)) +
                                ggtitle("Within-subs Replication Sub-level")
# trial filter
acc_test_within_rep_trial <- ggplot(ms_test_within_rep_collapse_trial, 
                                     aes(x=condition_trial, y=accuracy, 
                                         group=trialType, colour=trialType)) +
                                      geom_point(size=2) +
                                      geom_line() +
                                      geom_pointrange(aes(ymin=accuracy - ci_low,
                                                        ymax=accuracy + ci_high), width = .1) +
                                      geom_hline(yintercept=0.25, linetype = "dashed") +
                                      scale_y_continuous(limits=c(0,1)) +
                                      ggtitle("Within-subs Replication Trial-level")

#unfiltered
acc_test_within_rep_unfilt <- ggplot(ms_test_within_rep_collapse_unfilt, 
                               aes(x=condition_trial, y=accuracy, 
                                   group=trialType, colour=trialType)) +
                                geom_point(size=2) +
                                geom_line() +
                                geom_pointrange(aes(ymin=accuracy - ci_low,
                                                  ymax=accuracy + ci_high), width = .1) +
                                geom_hline(yintercept=0.25, linetype = "dashed") +
                                scale_y_continuous(limits=c(0,1)) +
                                ggtitle("Within-subs Replication Unfiltered")


multiplot(acc_test_within_rep_sub, acc_test_within_rep_trial, acc_test_within_rep_unfilt, cols=2)
```

Now model the within subs replication data

```{r within subjects replication model}
m1_within_rep <- glmer(correct ~ trialType * condition_trial + (trialType | subids),
            data = inc.data.within_rep_sub_level,
            family=binomial)
summary(m1_within_rep)

m1_within_rep_unfilt <- glmer(correct ~ trialType * condition_trial + (trialType | subids),
            data = inc.data.within_rep_unfilt,
            family=binomial)
summary(m1_within_rep_unfilt)
```

### Replot fyp data

```{r replot fyp}
read_path_fyp <- file.path("/Users", "kmacdonald", "Documents", 
                           "Projects", "SOC_XSIT", "processed_data", 
                           "adult-fyp/")

d_fyp_df <- tbl_df(read.csv(paste(read_path_fyp,
                                  "aggregate_soc_xsit.csv", sep="")))

d_fyp_df$condition <- factor(d_fyp_df$condition, 
                             levels = c("Social", "No-Social"))

acc_test_fyp <- ggplot(data=filter(d_fyp_df, intervalNum==0, numPicN==4),
                       aes(x=condition, y=correct, colour=trialType, group=trialType)) +
      geom_point(size = 2.5) +
      geom_line() +
      geom_pointrange(aes(ymin=correct - corr.cil,
                          ymax=correct + corr.cih), width = .1) +
      geom_hline(yintercept=0.25, linetype = "dashed") +
      scale_y_continuous(limits=c(0,1)) +
      xlab("Condition") +
      ylab("Proportion Correct") +
      labs(colour = "Trial Type") +
      ggtitle("FYP (between)")
```

#### Plot all accuracy data together using subject-level filter (FYP data, Between-subs design, Within-subs design)

- Removing subjects who got less than 25% correct on exp

```{r multiplot accuracy data subject level filter, fig.width=12, fig.height=6}
multiplot(acc_test_fyp, acc_test_btw_filt, acc_test_within_blocks_sub_level, acc_test_within_rep_blocks_sub_level, acc_test_within_sub, acc_test_within_rep_sub, cols=3)
```

#### Plot all accuracy data together using trial-level filter (FYP data, Between-subs design, Within-subs design)

- Removing trials on which subjects didn't select the target of eye gaze

```{r multiplot accuracy data trial level filter, fig.width=9, fig.height=6}
multiplot(acc_test_within_blocks_trial_level, acc_test_within_rep_blocks_trial_level, 
          acc_test_within_trial, acc_test_within_rep_trial, cols=2)
```


#### Plot all accuracy data together without filtering

```{r multiplot accuracy data trial level unfiltered, fig.width=9, fig.height=6}
multiplot(acc_test_btw, acc_test_within_blocks_unfilt, 
          acc_test_within_unfilt, acc_test_within_rep_unfilt, cols=2)
```
---
title: "Social Cross-Situational Word Learning"
author: "Kyle MacDonald & Allison Dods"
date: "July 14, 2014"
output: html_document
---

TODO: 
- relable RT -- test and exposure columns
- reorder gazeLength factor levels for plots

Analysis code for SOC-XSIT project. 

Load libraries.

```{r load libraries, message=FALSE, warning=FALSE}
library(bootstrap)
library(lme4)
library(ggplot2)
library(arm)
library(directlabels)
library(stringr)
library(plyr)
library(reshape2)
library(car)
library(dplyr)
library(xtable)
source("/Users/kmacdonald/Documents/Projects/SOC_XSIT/XSIT-MIN/analysis/Ranalysis/useful.R")
```

Read in data. 
- d is the first pilot (manipulated gaze length, 4-referents, 0 delay)
- d1 is the second pilot (just ran the short gaze condition and added the no-social condition )

```{r read data}
d <- read.csv("/Users/kmacdonald/Documents/Projects/SOC_XSIT/processed_data/soc_xsit_4_looks_pilot.csv")
d1 <- read.csv("/Users/kmacdonald/Documents/Projects/SOC_XSIT/processed_data/soc_xsit_4_looks_pilot_2.csv")
```

Get the number of subjects in each condition.

```{r get number of subs, echo=FALSE}
d.numSubs <- aggregate(correct ~ subid + gazeLength + condition, data=d, FUN=mean)
d.numSubs.summary <- count(d.numSubs, vars=c("gazeLength", "condition"))
d.numSubs.summary

d1.numSubs <- d.numSubs <- aggregate(correct ~ subid + gazeLength + condition, data=d1, FUN=mean)
d.numSubs.summary <- count(d1.numSubs, vars=c("gazeLength", "condition"))
d.numSubs.summary
```

Subset pilot 1 data for analysis.

```{r subset data}
d.test <- subset(d, testTrial==1)                               # test trials
d.first.trial <- subset(d, testTrial==1 & first.trial==TRUE)    # first test trial for each sub
d.exp <- subset(d, exposureTrial==1)                            # exposure trials
```

Did subjects choose target of gaze on exposure trials?

```{r exposure gaze target, echo=FALSE}
## match faceIdx to chosenIdx
d.exp$faceIdx <- revalue(d.exp$face, c("silentLDlong"=2, "silentLDmedium"=2, "silentLDshort"=2, 
                                        "silentLUlong"=0, "silentLUmedium"=0, "silentLUshort"=0, 
                                        "silentRDlong"=3, "silentRDmedium"=3, "silentRDshort"=3,
                                        "silentRUlong"=1, "silentRUmedium"=1, "silentRUshort"=1, 
                                        "straightahead"=-1))
## flag as true if subs chose target of gaze
d.exp$choseSocial <- NA 
d.exp$choseSocial <- d.exp$faceIdx == d.exp$chosenIdx

## get mean chose target of gaze by trial type, gazeLength condition, and sub id
mss.exp <- aggregate(choseSocial ~ trialType + subid + gazeLength, data=d.exp, FUN=mean)
ms.exp <- aggregate(choseSocial ~  gazeLength, data=mss.exp, FUN=mean)
ms.exp$choseSocial.cih <- aggregate(choseSocial ~ gazeLength, data=mss.exp, FUN=ci.high)$choseSocial
ms.exp$choseSocial.cil <- aggregate(choseSocial ~ gazeLength, data=mss.exp, FUN=ci.low)$choseSocial

## plot accuracy for three different gaze conditions
acc_exp <- ggplot(data=ms.exp, aes(x=gazeLength, y=choseSocial)) +
                geom_bar(stat="identity", fill="dodgerblue") +
                geom_errorbar(aes(ymin=choseSocial-choseSocial.cil, ymax=choseSocial+choseSocial.cih),
                              width=.2) +
                ylim(0,1) +
                xlab("Gaze Length") +
                ylab("Proportion of Subjects Chose Gaze Target") +
                theme_bw() 
acc_exp
```

Now subset test trials to include only those on which participants chose the target of gaze on exposure.

```{r clean test trials}
d.choseSocial <- subset(d.exp, select=c("subid", "itemNum",
                                        "choseSocial", "rt"))   # exposure trials chose gazeTar

d.test.gazeTar <- merge(d.test, d.choseSocial, 
                             by=c("subid", "itemNum"), 
                             all=TRUE)                          # test trials with exp trial info

d.test.choseGazeTar <- subset(d.test.gazeTar, 
                              choseSocial == TRUE, 
                              select=c(subid:rt.y))             # test trils: just chose gazeTar on exp

```

Clean out trials with extremely slow RTs (+/- 2SD).

```{r clean RTs}
d.test.choseGazeTar$correct[log(d.test.choseGazeTar$rt.x) > mean(log(d.test.choseGazeTar$rt.x)) + 2* sd(log(d.test.choseGazeTar$rt.x)) | log(d.test.choseGazeTar$rt.x) < mean(log(d.test.choseGazeTar$rt.x)) - 2* sd(log(d.test.choseGazeTar$rt.x))] <- NA
```

Accuracy on test trials (Same/Switch).

```{r acc on test trials, echo=FALSE, warning=FALSE, message=FALSE}
# now aggregate to get means 
mss.gaze.tar <- aggregate(correct ~ trialType + gazeLength + subid, data=d.test.choseGazeTar, 
                          FUN=mean, na.action = na.omit)

ms.gaze.tar <- aggregate(correct ~ trialType + gazeLength, data=mss.gaze.tar, 
                         FUN=mean, na.action = na.omit)

ms.gaze.tar$corr.cih <- aggregate(correct ~ trialType + gazeLength, data=mss.gaze.tar, 
                                  FUN=ci.high, na.action = na.omit)$correct

ms.gaze.tar$corr.cil <- aggregate(correct ~ trialType + gazeLength, 
                                  data=mss.gaze.tar, FUN=ci.low, na.action = na.omit)$correct

# plot accuracy by gazeLength and trialType
exp.gazeLength <- factor(ms.gaze.tar$gazeLength, c("Short", "Medium", "Long"))

acc_plot <- qplot(data=ms.gaze.tar,x=exp.gazeLength, y=correct, linetype=trialType, 
                  ymin=correct-corr.cil, ymax=correct+corr.cih,
                    colour=gazeLength, 
                    geom=c("pointrange", "line"),
                    position=position_dodge(width=.02)) +
        scale_y_continuous(limits = c(0,1),breaks=c(0,.25,.5,.75,1),
                       name = "Prop. Choosing Repeated Referent") +
        geom_hline(aes(yintercept=1/4),lty=2)

acc_plot

```

RT on exposure trials.

```{r RT on exposure trials}
mss.exp.rt <- aggregate(rt ~  gazeLength + subid, data=d.exp, FUN=mean)

# remove +/- 2SD
mss.exp.rt$rt[log(mss.exp.rt$rt) > mean(log(mss.exp.rt$rt)) + 2* sd(log(mss.exp.rt$rt)) | 
                log(mss.exp.rt$rt) < mean(log(mss.exp.rt$rt)) - 2* sd(log(mss.exp.rt$rt))] <- NA
ms.exp.rt <- aggregate(rt ~ gazeLength, data=mss.exp.rt, FUN=mean)
ms.exp.rt$rt.cih <- aggregate(rt ~ gazeLength, data=mss.exp.rt, FUN=ci.high)$rt
ms.exp.rt$rt.cil <- aggregate(rt ~ gazeLength, data=mss.exp.rt, FUN=ci.low)$rt

## plots mean reaction time for the different exposure conditions 
rt_exp <- ggplot(data=ms.exp.rt, aes(x=gazeLength, y=rt, fill=gazeLength)) +
                geom_bar(stat="identity") +
                geom_errorbar(aes(ymin=rt-rt.cil, ymax=rt+rt.cih,),
                              width=.2) +
                xlab("Gaze Length") +
                ylab("Reaction Time") +
                theme_bw() 

rt_exp
```

RT on test trials.

```{r RT on test trials}
mss.test.rt <- aggregate(rt.x ~  gazeLength + trialType + subid, data=d.test.choseGazeTar, FUN=mean)
# remove +/- 2SD
mss.test.rt$rt[log(mss.test.rt$rt) > mean(log(mss.test.rt$rt)) + 2* sd(log(mss.test.rt$rt)) | 
                log(mss.test.rt$rt) < mean(log(mss.test.rt$rt)) - 2* sd(log(mss.test.rt$rt))] <- NA
ms.test.rt <- aggregate(rt ~ gazeLength + trialType, data=mss.test.rt, FUN=mean)
ms.test.rt$rt.cih <- aggregate(rt ~ gazeLength + trialType, data=mss.test.rt, FUN=ci.high)$rt
ms.test.rt$rt.cil <- aggregate(rt ~ gazeLength + trialType, data=mss.test.rt, FUN=ci.low)$rt

rt_test_plot <- qplot(data=ms.test.rt,x=gazeLength, y=rt)

rt_test_plot
```

Subset pilot 2 data for analysis.

```{r subset pilot 2}
d1.test <- subset(d1, testTrial==1)                               # test trials
d1.first.trial <- subset(d1, testTrial==1 & first.trial==TRUE)    # first test trial for each sub
d1.exp <- subset(d1, exposureTrial==1)                            # exposure trials
```

```{r exposure gaze target pilot 2, echo=FALSE}
## match faceIdx to chosenIdx
d1.exp$faceIdx <- revalue(d1.exp$face, c("silentLDlong"=2, "silentLDmedium"=2, "silentLDshort"=2, 
                                        "silentLUlong"=0, "silentLUmedium"=0, "silentLUshort"=0, 
                                        "silentRDlong"=3, "silentRDmedium"=3, "silentRDshort"=3,
                                        "silentRUlong"=1, "silentRUmedium"=1, "silentRUshort"=1, 
                                        "straightahead"=-1))
## flag as true if subs chose target of gaze
d1.exp$choseSocial <- NA 
d1.exp$choseSocial <- d1.exp$faceIdx == d1.exp$chosenIdx

## get mean chose target of gaze by trial type, gazeLength condition, and sub id
mss.exp.1 <- aggregate(choseSocial ~ trialType + subid + condition, data=d1.exp, FUN=mean)
ms.exp.1 <- aggregate(choseSocial ~  condition, data=mss.exp.1, FUN=mean)
ms.exp.1$choseSocial.cih <- aggregate(choseSocial ~ condition, data=mss.exp.1, FUN=ci.high)$choseSocial
ms.exp.1$choseSocial.cil <- aggregate(choseSocial ~ condition, data=mss.exp.1, FUN=ci.low)$choseSocial

## plot accuracy for three different gaze conditions
acc_exp_pilot2 <- ggplot(data=ms.exp.1, aes(x=condition, y=choseSocial)) +
                geom_bar(stat="identity", fill="dodgerblue") +
                geom_errorbar(aes(ymin=choseSocial-choseSocial.cil, ymax=choseSocial+choseSocial.cih),
                              width=.2) +
                ylim(0,1) +
                xlab("Gaze Length") +
                ylab("Proportion of Subjects Chose Gaze Target") +
                theme_bw() 
acc_exp_pilot2
```

Now subset test trials to include only those on which participants chose the target of gaze on exposure.

```{r clean test trials pilot 2}
d1.choseSocial <- subset(d1.exp, select=c("subid", "itemNum",
                                        "choseSocial", "rt"))   # exposure trials chose gazeTar

d1.test.gazeTar <- merge(d1.test, d1.choseSocial, 
                             by=c("subid", "itemNum"), 
                             all=TRUE)                          # test trials with exp trial info

d1.test.choseGazeTar <- subset(d1.test.gazeTar, 
                              choseSocial == TRUE || condition == "No-social", 
                              select=c(subid:rt.y))             # test trials: just chose gazeTar on exp
```

Now plot accuracy on test trials

```{r pilot2 acc on test, echo=F, warning=FALSE}
# now aggregate to get means 
mss.gaze.tar.1 <- aggregate(correct ~ trialType + condition + subid, data=d1.test.choseGazeTar, 
                          FUN=mean, na.action = na.omit)

ms.gaze.tar.1 <- aggregate(correct ~ trialType + condition, data=mss.gaze.tar.1, 
                         FUN=mean, na.action = na.omit)

ms.gaze.tar.1$corr.cih <- aggregate(correct ~ trialType + condition, data=mss.gaze.tar.1, 
                                  FUN=ci.high, na.action = na.omit)$correct

ms.gaze.tar.1$corr.cil <- aggregate(correct ~ trialType + condition, 
                                  data=mss.gaze.tar.1, FUN=ci.low, na.action = na.omit)$correct

# plot accuracy by condition and trialType
acc_plot_test_p1 <- qplot(data=ms.gaze.tar.1,x=condition, y=correct, linetype=trialType, 
                  ymin=correct-corr.cil, ymax=correct+corr.cih,
                    colour=condition, 
                    geom=c("pointrange", "line"),
                    position=position_dodge(width=.02)) +
        scale_y_continuous(limits = c(0,1),breaks=c(0,.25,.5,.75,1),
                       name = "Prop. Choosing Repeated Referent") +
        geom_hline(aes(yintercept=1/4),lty=2)

acc_plot_test_p1
```

Lmer to see if difference between social and no-social is reliable 

```{r lmer pilot 2}
m1.l <- glmer(correct ~ trialType * condition + (1|subid), 
            data=d1.test.choseGazeTar, family=binomial)
aggregate(correct ~ trialType + condition, d1.test.choseGazeTar, mean)
aggregate(subid ~ trialType + condition, d1.test.choseGazeTar, n.unique)

summary(m1.l)
```


```{r}

m2.l <- glmer(correct ~ condition + 
            (1|subid), 
            data=subset(d1.test.choseGazeTar, trialType=="Same"), family=binomial, nAGQ=0)

summary(m2.l)

```
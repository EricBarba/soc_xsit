---
title: "ipad-data-cleaning"
author: "Kyle MacDonald"
date: "August 4, 2014"
output: html_document
---

Script to munge ipad data for soc-xsit project

TODO:
- Get condition to read in 
- Get subid from filename
- Compute correct variable 

Load libraries for data manipulation

```{r load_libraries, echo=F}
library(ggplot2)
library(plyr)
library(dplyr)
library(directlabels)
library(bootstrap)
library(grid)
library(gridExtra)
library(stringr)
```

Load helper functions for computing measurement error.

```{r helpers, echo=FALSE}
sem <- function(x) {sd(x,na.rm=TRUE)/sqrt(length(x)-sum(is.na(x)))}
ci95 <- function(x) {1.96*sem(x)}

## code for bootstrapping 95% confidence intervals
theta <- function(x,xdata,na.rm=T) {mean(xdata[x],na.rm=na.rm)}
ci.low <- function(x,na.rm=T) {
  mean(x,na.rm=na.rm) - quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.025,na.rm=na.rm)}
ci.high <- function(x,na.rm=T) {
  quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.975,na.rm=na.rm) - mean(x,na.rm=na.rm)}
```

Read in the data, which are stored in separate .txt files for each participant.

```{r munging, tidy=TRUE}
# Create empty arrays for binding 
all.data <- as.data.frame(matrix(ncol = 0, nrow = 0))

#grab all file names from data dir. 
#These are all of the kids for whom we have ipad data
all_results <- list.files(path = "/Users/kmacdonald/Documents/Projects/SOC_XSIT/raw_data/child/",
                          pattern = 'results_*', all.files = FALSE)

#function to munge the data
#takes in a list of filenames (.txt of each kid's data), 
#strips html escape characters, and grabs the relevant info for each trial
#returns data frame with all the data
bing_clean <- function(filename) {
        x <- readLines(paste("/Users/kmacdonald/Documents/Projects/SOC_XSIT/raw_data/child/", 
                                filename,sep=""),warn=FALSE)
        x <- unlist(strsplit(x,'<li>'))
        
        #grab condition 
        condition <- x[3]

        if (grepl(pattern="Social", condition)) {
                condition <- str_extract(pattern="Social", condition)
        } else {
                condition <- str_extract(pattern="No-social", condition)
        }
                
        # grab trial information 
        x <- x[11:150]
        
        #strip html characters
        x <- gsub('\\"',"", x)
        x <- gsub("\\\\\"","",x)
        x <- gsub("</li>","",x)
        x <- gsub("</ul>\\},\\{<ul>","",x)
        x[length(x)] <- gsub("</ul>\\}]","",x[length(x)])
        x <- gsub("^.*?: ","",x)
        
        #grab date 
        date <- str_sub(filename,20,36)
        date <- gsub('_','',date)
        date <- gsub('\\.','',date)
        #grab id
        id <- str_sub(filename,0,2)
        id <- gsub('-','',id)
        #bind to data frame
        x <- as.data.frame(matrix(x,14,10,byrow=TRUE), stringsAsFactors=F)
        x$V11 <- date
        x$V12 <- id
        x$V13 <- condition
        return(x) ## need this return to get the data frame!
}

#apply munging function to each kid's data file
all.data <- ldply(
                .data = all_results,
                .fun = bing_clean
                )

#add variable names to columns
names(all.data) <- c("itemNum","trialType","samePos","chosen","chosen_idx",
              "kept","kept_idx","rt","faceVid","faceIdx", "date", "id", "condition")
 
```

Tag the different trial types: example, exposure, and test.

```{r tag-trial-types}
#dplyr syntax
all.data <- all.data %>% 
                group_by(date) %>%
                mutate(trial = c(1:14)) %>%
                mutate(example_trial = ifelse(trial %in% c(1:2),1,0),
                       exposure_trial = ifelse(trial %in% c(3,5,7,9,11,13),1,0),
                       test_trial = ifelse(trial %in% c(4,6,8,10,12,14),1,0),
                       include = ifelse(chosen[1] == "flower" & 
                                        chosen[2] == "truck",1,0)) %>%
                arrange(date, trial)

#reorder columns to put id, date, and condition first
temp <- all.data[c("id","date", "condition", "itemNum","trialType","samePos",
                   "chosen","chosen_idx","kept","kept_idx","rt","faceVid","faceIdx",
                   "trial","example_trial","exposure_trial","test_trial","include")]
```

Clean up the data. Exclude subjects for getting examples wrong

```{r, data-cleaning}
#find whether child's choice was correct 
#for exposure trials, we check the index of eye gaze against child's choice
#for test trials, we check the kept image against the child's choice 
all.data <- all.data %>% 
                group_by(id) %>%
                mutate(correct = ifelse(exposure_trial == 1, chosen_idx == faceIdx, 
                                 ifelse(example_trial == 1, chosen[1] == "flower" & chosen[2] == "truck",
                                        chosen == kept))) 

#relabel variables and variable types for analysis
all.data$trialType <- factor(all.data$trialType, labels = c('Same','Switch'))
all.data$rt <- as.integer(all.data$rt)
all.data$condition <- as.factor(all.data$condition)

##RT Exclusions##
```

Add demographic data for each child (age and gender).

```{r, demographics}

#add ages and genders from demos
keep.data$age <- demos$Age[keep.data$subj]
keep.data$gender <- demos$Gender[keep.data$subj]
keep.data$language <- demos$Language[keep.data$subj]

#dropped kids ages
#demos$Age[include.subs[include.subs$include==FALSE,]$subj]

#compute age group by taking floor of age (round down to year)
keep.data$age.grp <- floor(keep.data$age*2)/2

#drop wrong age kids
keep.data <- keep.data[keep.data$age.grp >= 3,]
keep.data <- keep.data[keep.data$age.grp < 6,]

#CDM subset
#keep.data <- keep.data[is.na(keep.data$language) | keep.data$language >=90,]
```

Now we have a tidy data file that we can analyze. 

---
title: "ipad-data-cleaning"
author: "Kyle MacDonald"
date: "August 4, 2014"
output: html_document
---

Script to munge ipad data for soc-xsit project

TODO:
- Get condition to read in 
- Get subid from filename
- Compute correct variable 

Load libraries for data manipulation

```{r load_libraries, echo=F}
library(ggplot2)
library(plyr)
library(dplyr)
library(directlabels)
library(bootstrap)
library(grid)
library(gridExtra)
```

Load helper functions for computing measurement error.

```{r helpers, echo=FALSE}
sem <- function(x) {sd(x,na.rm=TRUE)/sqrt(length(x)-sum(is.na(x)))}
ci95 <- function(x) {1.96*sem(x)}

## code for bootstrapping 95% confidence intervals
theta <- function(x,xdata,na.rm=T) {mean(xdata[x],na.rm=na.rm)}
ci.low <- function(x,na.rm=T) {
  mean(x,na.rm=na.rm) - quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.025,na.rm=na.rm)}
ci.high <- function(x,na.rm=T) {
  quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.975,na.rm=na.rm) - mean(x,na.rm=na.rm)}
```

Read in the data, which are stored in separate .txt files for each participant.

```{r munging, tidy=TRUE}
# Create empty arrays for binding 
all.data <- as.data.frame(matrix(ncol = 0, nrow = 0))

#grab all file names from data dir. 
#These are all of the kids for whom we have ipad data
all_results <- list.files(path = "/Users/kmacdonald/Documents/Projects/SOC_XSIT/raw_data/child/", pattern = 'results_*', all.files = FALSE);

#function to munge the data
#takes in a list of filenames (.txt of each kid's data), 
#strips html escape characters, and grabs the relevant info for each trial
#returns data frame with all the data
bing_clean <- function(filename) {
        x <- readLines(paste("/Users/kmacdonald/Documents/Projects/SOC_XSIT/raw_data/child/", 
                                filename,sep=""),warn=FALSE)
        x <- unlist(strsplit(x,'<li>'))
        #select info relevant to trial
        x <- x[11:150]
        #strip html characters
        x <- gsub('\\"',"", x)
        x <- gsub("\\\\\"","",x)
        x <- gsub("</li>","",x)
        x <- gsub("</ul>\\},\\{<ul>","",x)
        x[length(x)] <- gsub("</ul>\\}]","",x[length(x)])
        x <- gsub("^.*?: ","",x)
        #grab date from file name and add to flattened list
        date <- paste(substr(filename,18,33))
        #bind to data frame
        x <- as.data.frame(matrix(x,14,10,byrow=TRUE), stringsAsFactors=F)
        x$V11 <- date
        return(x) ## need this return to get the data frame!
}

#apply munging function to each kid's data file
all.data <- 
        ldply(
                .data = all_results,
                .fun = bing_clean
        )

#add variable names to columns
names(all.data) <- c("itemNum","trialType","samePos","chosen","chosen_idx",
              "kept","kept_idx","rt","faceVid","faceIdx", "date")
 
```

Tag the different trial types: example, exposure, and test.

```{r tag-trial-types}
all.data <- all.data %>% 
                group_by(date) %>%
                mutate(trial = c(1:14)) %>%
                mutate(example_trial = ifelse(trial %in% c(1:2),1,0),
                       exposure_trial = ifelse(trial %in% c(3,5,7,9,11,13),1,0),
                       test_trial = ifelse(trial %in% c(4,6,8,10,12,14),1,0))
```

Clean up the data. Exclude subjects for getting examples wrong

```{r, data-cleaning}

# exclude for getting examples wrong
include.subs <- ddply(example.data,.(subj), 
                      function(x) {
                        check <- x$chosen[1] == "shoe" & 
                                 x$chosen[2] == "shoe" & 
                                 x$chosen[3] == "cup" &
                                 x$chosen[4] == "cup" & 
                                 x$chosen[5] == "flower" & 
                                 x$chosen[6] == "flower" & 
                                 x$chosen[7] == "truck" &
                                 x$chosen[8] == "truck" 
                        return(check)
                        })


#rename columns of include.subs to semantically interpretable labels
names(include.subs) <- c("subj","include")

#relabel trial-types to semantically interpretable variables
test.data$trialType <- factor(test.data$trialType, labels = c('Same','Switch'))

#find whether each choice was correct
test.data$chosen <- as.character(test.data$chosen)
test.data$kept <- as.character(test.data$kept)
test.data$correct <- test.data$chosen == test.data$kept

#overwrite responses where the kid switched sides
test.data$overwrite <- 0

for(f in 1:nrow(overwrite)) {
 
  inds <- test.data$subj==overwrite$subj[f] & 
    test.data$itemNum==overwrite$itemNum[f]
  
  test.data$correct[inds] <- overwrite$correct[f]
  test.data$overwrite[inds] <- overwrite$correct[f]
}

#append include value to test.data, keep only kids who should be included
test.data <- merge(test.data,include.subs)
keep.data <- subset(test.data,include)

#sort and clean up keep.data
keep.data <- keep.data[with(keep.data,order(subj,trialType,itemNum)),]
keep.data <- keep.data[,! names(keep.data) %in% 
                         c("chosen_idx","kept_idx","chosen","kept","include")]

#add in early data, reorder trial type (for some reason)
keep.data <- rbind(early.data,keep.data)
keep.data$trialType <- factor(keep.data$trialType, levels=c("Same","Switch"))

keep.data$rt <- as.integer(keep.data$rt)

##RT Exclusions##
keep.data$log.rt <- log(keep.data$rt)
mean.rt <- mean(keep.data$log.rt,na.rm=TRUE)
high.rt <- mean.rt+3*sd(keep.data$log.rt,na.rm=TRUE)
low.rt <- mean.rt-3*sd(keep.data$log.rt,na.rm=TRUE)

keep.data <- keep.data[with(keep.data,is.na(rt) |
                              (log.rt < high.rt & log.rt >low.rt) | 
                              overwrite == 1),]

## DROP KIDS THAT EXPERIMENTERS SAID HAD PROBLEMS
#BING
#drop 7 and 12
keep.data <- keep.data[keep.data$subj != 7,]
keep.data <- keep.data[keep.data$subj != 12,]

#CDM
#drop 124, 128
keep.data <- keep.data[keep.data$subj != 124,]
keep.data <- keep.data[keep.data$subj != 128,]
keep.data <- keep.data[keep.data$subj != 130,]
keep.data <- keep.data[keep.data$subj != 164,]
keep.data <- keep.data[keep.data$subj != 210,]

# keep.data <- keep.data[keep.data$subj != 171,]
# keep.data <- keep.data[keep.data$subj != 200,]
```

Add demographic data for each child (age and gender).

```{r, demographics}

#add ages and genders from demos
keep.data$age <- demos$Age[keep.data$subj]
keep.data$gender <- demos$Gender[keep.data$subj]
keep.data$language <- demos$Language[keep.data$subj]

#dropped kids ages
#demos$Age[include.subs[include.subs$include==FALSE,]$subj]

#compute age group by taking floor of age (round down to year)
keep.data$age.grp <- floor(keep.data$age*2)/2

#drop wrong age kids
keep.data <- keep.data[keep.data$age.grp >= 3,]
keep.data <- keep.data[keep.data$age.grp < 6,]

#CDM subset
#keep.data <- keep.data[is.na(keep.data$language) | keep.data$language >=90,]
```

Now we have a tidy data file that we can analyze. 
